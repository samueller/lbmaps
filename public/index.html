<html>
    <head>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script src="util.js"></script>
		<link href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css" rel="stylesheet">
        <style>
            .possibility-window {
                color: yellow;
                font-weight: bold;
            }
            .monotonicity-window {
                color: orange;
                font-weight: bold;
            }
            .legend {
                background-color: rgba(0, 0, 0, 0.5);
                color: white;
                padding: 0 5px;
            }
        </style>
        <script>
            const impossibleColor = 'rgba(0, 0, 0, 0.7)'
            const possibleColor = 'rgba(255, 255, 255, 0)'
            const monotonicityColor = 'rgba(255, 255, 255, 0.18)'

            const urlParams = new URLSearchParams(window.location.search)
            const floatParam = name => def =>
                parseFloat(urlParams.get(name) || def)

            const disableInput = disabled => input => input.disabled = disabled
            const disableObservationalInputs = disabled =>
                [ pyCxSlider
                , pyCxpSlider
                , pxSlider
                ].map(disableInput(disabled))

            let contourType = floatParam('data')(0)
            let observations = floatParam('obs')(1) == 1
            let pyCx = floatParam('pycx')('0.5')
            let pyCxp = floatParam('pycxp')('0.5')
            let px = floatParam('px')('0.5')
            let pxp = 1 - px
            let pxy
            let pxpy
            let py

            const contourDataFuncs =
                [ py =>
                    ({ x: [0, py, py, 1]
                     , y: [0, py, py, 1]
                     , z:
                        [ [py, py, py, 1]
                        , [0, 0, 0, 1 - py]
                        , [null, null, 0, 1 - py]
                        , [null, null, 0, 1 - py]
                        ]
                    })
                , py =>
                    ({ x: [0, 1]
                     , y: [0, 1]
                     , z:
                        [ [ null, 0 ]
                        , [ 0, 1 ]
                        ]
                    })
                , py =>
                    ({ x: [0, 1]
                     , y: [0, 1]
                     , z:
                        [ [ 1, 0 ]
                        , [ 0, null ]
                        ]
                    })
                , py =>
                    ({ x: [0, py, py, 1]
                     , y: [0, py, py, 1]
                     , z:
                        [ [py, 0, null, null]
                        , [py, 0, null, null]
                        , [py, 0, 0, 0]
                        , [1, 1 - py, 1 - py, 1 - py]
                        ]
                    })
                ]

            
            const contourDataFuncsExperimental =
                [ { x: [0, 1]
                  , y: [0, 1]
                  , z:
                    [ [ 0, 1 ]
                    , [ null, 0 ]
                    ]
                  }
                , { x: [0, 1]
                  , y: [0, 1]
                  , z:
                    [ [ null, 0 ]
                    , [ 0, 1 ]
                    ]
                  }
                , { x: [0, 1]
                  , y: [0, 1]
                  , z:
                    [ [ 1, 0 ]
                    , [ 0, null ]
                    ]
                  }
                , { x: [0, 1]
                  , y: [0, 1]
                  , z:
                    [ [ 0, null ]
                    , [ 1, 0 ]
                    ]
                  }
                ]

            const data =
                { type: 'contour'
                , name: ''
                , line: { smoothing: 0 }
                , hovertemplate: 'P(y<sub>x</sub>) = %{x}<br>P(y<sub>x\'</sub>) = %{y}<br>P(y<sub>x</sub>, y\'<sub>x\'</sub>) ≥ %{z}'
                , colorbar:
                    { title: 'P(y<sub>x</sub>, y\'<sub>x\'</sub>) ≥'
                    }
                }

            const shapes = py =>
                [ { type: 'rect'
                  , x0: 0
                  , y0: 0
                  , x1: pxy
                  , y1: 1
                  , fillcolor: impossibleColor
                  , line: { width: 0 }
                  }
                , { type: 'rect'
                  , x0: pxy
                  , y0: py - pxy + px
                  , x1: pxy + pxp
                  , y1: 1
                  , fillcolor: impossibleColor
                  , line: { width: 0 }
                  }
                , { type: 'rect'
                  , x0: pxy
                  , y0: 0
                  , x1: py//pxy + pxp
                  , y1: py - pxy
                  , fillcolor: impossibleColor
                  , line: { width: 0 }
                  }
                , { type: 'rect'
                  , x0: pxy + pxp
                  , y0: py//0
                  , x1: 1
                  , y1: 1
                  , fillcolor: impossibleColor
                  , line: { width: 0 }
                  }
                , { type: 'line'
                  , x0: 0
                  , y0: 0
                  , x1: 1
                  , y1: 1
                  , line:
                    { color: 'red'
                    , width: 2
                    , dash: 'dot'
                    }
                  }
                , { type: 'rect'
                  , x0: pxy
                  , y0: py - pxy
                  , x1: pxy + pxp
                  , y1: py - pxy + px
                  , fillcolor: possibleColor
                  , line: { color: 'yellow', width: 2 }
                  }
                , { type: 'rect'
                  , x0: py
                  , y0: 0
                  , x1: 1
                  , y1: py
                //   , fillcolor: monotonicityColor
                  , line: { color: 'orange', width: 2 }
                  }
                ]  
        </script>
    </head>
    <body>
        <section class="section" style="padding-top: 10px">
            <div class="control">
                <label class="radio" for="compliers"><input id="compliers" name="map" type="radio" checked> Compliers</label>
                <label class="radio" for="always-takers"><input id="always-takers" name="map" type="radio"> Always takers</label>
                <label class="radio" for="never-takers"><input id="never-takers" name="map" type="radio"> Never takers</label>
                <label class="radio" for="defiers"><input id="defiers" name="map" type="radio"> Defiers</label>
            </div>
            <p class="content legend">
                <span class="possibility-window">☐</span>: Possibility window,
                <span class="monotonicity-window">☐</span>: Necessary test for monotonicity
            </p>
            <div id="graph"></div>
            <div class="control">
                <label class="checkbox"><script>document.writeln(`<input id="observations" type="checkbox" ${observations ? 'checked' : ''}>`)</script> Observational probabilities?</label>
            </div>
            <!-- <input id="py-slider" min="0" max="1" value="0.5" step="0.05" type="range">
            <output id="py-output" for="py-slider">P(y) = 0.5</output>
            <br> -->
            <input id="pycx-slider" min="0" max="1" value="0.5" step="0.05" type="range">
            <output id="pycx-output" for="pycx-slider">P(y|x) = 0.5</output>
            <br>
            <input id="pycxp-slider" min="0" max="1" value="0.5" step="0.05" type="range">
            <output id="pycxp-output" for="pycxp-slider">P(y|x') = 0.5</output>
            <!-- <br>
            <input id="pxy-slider" min="0" max="1" value="0.25" step="0.05" type="range">
            <output id="pxy-output" for="pxy-slider">P(x, y) = 0.25 (P(x, y') = 0.25, P(x', y) = 0.75, P(x', y') = 0.75)</output> -->
            <br>
            <input id="px-slider" min="0" max="1" value="0.5" step="0.05" type="range">
            <output id="px-output" for="px-slider">P(x) = 0.5 (P(x') = 0.5)</output>
            <br>
            <output id="py-output" for="py-slider">P(y) = 0.5</output>, <output id="pxy-output">P(x, y) = 0.25, P(x, y') = 0.25, P(x', y) = 0.75, P(x', y') = 0.75</output>
            <br><br>
            <p><a href="3dscatter.html">3d scatter plot version</a></p>
        </section>
        <script>            
            const mapNames =
                [ 'P(y<sub>x</sub>, y\'<sub>x\'</sub>)'
                , 'P(y<sub>x</sub>, y<sub>x\'</sub>)'
                , 'P(y\'<sub>x</sub>, y\'<sub>x\'</sub>)'
                , 'P(y\'<sub>x</sub>, y<sub>x\'</sub>)'
                ]

            const layout = observations =>
                ({ title: `Lower Bounds on ${mapNames[contourType]}`
                 , xaxis: { title: 'P(y<sub>x</sub>)'}
                 , yaxis: { title: 'P(y<sub>x\'</sub>)'}
                 , shapes: observations ? shapes(py) : {}
                 , width: 600
                 , height: 600
                })

            const dataAndLayout = contourType => observations =>
                ({ data: [ observations
                    ? Object.assign({}, contourDataFuncs[contourType](py), data)
                    : Object.assign({}, contourDataFuncsExperimental[contourType], data)
                    ]
                 , layout: layout(observations)
                 })

            const createGraph = graph => contourType =>
                Plotly.newPlot
                    ( graph
                    , dataAndLayout(contourType)(observations)
                    )
            const animateGraph = graph => contourType =>
                Plotly.react
                    ( graph
                    , dataAndLayout(contourType)(observations)
                    )

            const graph = document.getElementById('graph')
            // const pySlider = document.getElementById('py-slider')
            const pyOutput = document.getElementById('py-output')
            const pyCxSlider = document.getElementById('pycx-slider')
            const pyCxpSlider = document.getElementById('pycxp-slider')
            const pyCxOutput = document.getElementById('pycx-output')
            const pyCxpOutput = document.getElementById('pycxp-output')
            const pxyOutput = document.getElementById('pxy-output')
            const pxSlider = document.getElementById('px-slider')
            const pxOutput = document.getElementById('px-output')

            const round2 = x =>
                Math.round(x * 100) / 100
            const updatePyCxOutput = pyCx =>
                pyCxOutput.value = `P(y|x) = ${round2(pyCx)}`
            const updatePyCxpOutput = pyCxp =>
                pyCxpOutput.value = `P(y|x') = ${round2(pyCxp)}`
            const updatePxOutput = px =>
                pxOutput.value = `P(x) = ${round2(px)} (P(x') = ${round2(pxp)})`

            const updateDepVars = () => {
                pxy = pyCx * px
                pxpy = pyCxp * pxp
                py = pxy + pxpy
                pxyOutput.value = `P(x, y) = ${round2(pxy)}, P(x, y') = ${round2(px - pxy)}, P(x', y) = ${round2(pxpy)}, P(x', y') = ${round2(pxp - pxpy)}`
                pyOutput.value = `P(y) = ${round2(py)}`
            }

            const update = graph => contourType => {
                updateDepVars()
                animateGraph(graph)(contourType)
            }

            updatePyCxOutput(pyCx)
            updatePyCxpOutput(pyCxp)
            updatePxOutput(px)
            updateDepVars()
            disableObservationalInputs(!observations)
            createGraph(graph)(contourType)
            // const updatePY = newPY => {
            //     py = newPY
            //     const pycxp = (newPY - pxy) / pxp
            //     // pySlider.value = py
            //     pycxpSlider.value = pycxp
            //     pycxpOutput.value = `P(y|x') = ${round2(pycxp)}`
            //     pyOutput.value = `P(y) = ${round2(py)}`
            // }
            // const updatePXY = newPXY => {
            //     pxy = newPXY
            //     const pycx = newPXY / px
            //     pycxSlider.value = pycx
            //     pycxOutput.value = `P(y|x) = ${round2(pycx)}`
            //     pxyOutput.value = `P(x, y) = ${round2(pxy)}, P(x, y') = ${round2(px - pxy)}, P(x', y) = ${round2(py - pxy)}, P(x', y') = ${round2(pxp - py + pxy)}`
            //     // pxySlider.value = pxy
            //     // pxyOutput.value = `P(x, y) = ${pxy} (P(x, y') = ${px - pxy}, P(x', y) = ${py - pxy}, P(x', y') = ${pxp - py + pxy})`
            // }            
            const updatePyCx = newPyCx => {
                pyCx = newPyCx
                updatePyCxOutput(pyCx)
                update(graph)(contourType)
            }
            const updatePyCxp = newPyCxp => {
                pyCxp = newPyCxp
                updatePyCxpOutput(pyCxp)
                update(graph)(contourType)
            }
            const updatePx = newPX => {
                px = newPX
                pxp = 1 - px
                updatePxOutput(px)
                update(graph)(contourType)
            }
            // document.getElementById('py-slider').addEventListener('input', e => {
            //     py = e.target.valueAsNumber
            //     if (py < pxy)
            //         updatePXY(py)
            //     else if (py - pxy + px > 1)
            //         updatePXY(py - pxp)
            //     else
            //         updatePXY(pxy)
            //     pyOutput.value = `P(y) = ${round2(py)}`
            //     createGraph(graph)(contourType)
            // })

            const onTargetNumber = f => e => f(e.target.valueAsNumber)

            document
                .getElementById('pycx-slider')
                .addEventListener('input', onTargetNumber(updatePyCx))
                // pycx = e.target.valueAsNumber
                // pxy = pycx * px
                // py = pxy + pxpy
                // if (pxy + pxp > 1)
                //     updatePX(pxy)
                // else if (py - pxy + px > 1)
                //     updatePX(pxy - py + 1)
                // if (py < pxy)
                //     updatePY(pxy)
                // pyCxOutput.value = `P(y|x) = ${round2(pyCx)}`
                // pxyOutput.value = `P(x, y) = ${round2(pxy)}, P(x, y') = ${round2(px - pxy)}, P(x', y) = ${round2(py - pxy)}, P(x', y') = ${round2(pxp - py + pxy)}`
                // pyOutput.value = `P(y) = ${round2(py)}`
                // createGraph(graph)(contourType)
                // animateGraph(graph)(contourType)
            // })
            document
                .getElementById('pycxp-slider')
                .addEventListener('input', onTargetNumber(updatePyCxp))
                // pycxp = e.target.valueAsNumber
                // pxpy = pycxp * pxp
                // py = pxpy + pxy
                // if (py < pxy)
                //     updatePXY(py)
                // else if (py - pxy + px > 1)
                //     updatePXY(py - pxp)
                // else
                //     updatePXY(pxy)
                // pyCxpOutput.value = `P(y|x') = ${round2(pyCxp)}`
                // pyOutput.value = `P(y) = ${round2(py)}`
                // animateGraph(graph)(contourType)
            // })
            // document.getElementById('pxy-slider').addEventListener('input', e => {
            //     pxy = e.target.valueAsNumber
            //     if (pxy + pxp > 1)
            //         updatePX(pxy)
            //     else if (py - pxy + px > 1)
            //         updatePX(pxy - py + 1)
            //     if (py < pxy)
            //         updatePY(pxy)
            //     pxyOutput.value = `P(x, y) = ${pxy} (P(x, y') = ${px - pxy}, P(x', y) = ${py - pxy}, P(x', y') = ${pxp - py + pxy})`
            //     createGraph(graph)(contourType)
            // })
            document.getElementById('px-slider').addEventListener('input', e => {
                if (py - pxy + px > 1 || pxy + pxp > 1)
                    pxSlider.value = px
                else
                    updatePx(e.target.valueAsNumber)
                // px = e.target.valueAsNumber
                // pxp = 1 - px
                // if (py - pxy + px > 1)
                //     updatePXY(py - pxp)
                // else if (pxy + pxp > 1)
                //     updatePXY(px)
                // else
                //     updatePXY(pxy)
                // pxOutput.value = `P(x) = ${round2(px)} (P(x') = ${round2(pxp)})`
                // animateGraph(graph)(contourType)
            })
            const setContourType = newContourType => {
                contourType = newContourType
                animateGraph(graph)(contourType)
            }
            const compliersButton = document.getElementById('compliers')
            const alwaysTakersButton = document.getElementById('always-takers')
            const neverTakersButton = document.getElementById('never-takers')
            const defiersButton = document.getElementById('defiers')
            compliersButton.addEventListener('input', e => setContourType(0))
            alwaysTakersButton.addEventListener('input', e => setContourType(1))
            neverTakersButton.addEventListener('input', e => setContourType(2))
            defiersButton.addEventListener('input', e => setContourType(3))

            document.getElementById('observations').addEventListener('change', e => {
                observations = e.target.checked
                disableObservationalInputs(!observations)
                animateGraph(graph)(contourType)
            })
        </script>
    </body>
</html>